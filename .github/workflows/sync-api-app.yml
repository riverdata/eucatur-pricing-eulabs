name: Sync API and APP to Repo

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout projeto API
        uses: actions/checkout@v4
        with:
          repository: riverdata/eucatur-pricing-api
          token: ${{ secrets.PRIVATE_TOKEN_EULABS }}
          path: temp-api

      - name: Checkout projeto APP
        uses: actions/checkout@v4
        with:
          repository: riverdata/eucatur-pricing-app
          token: ${{ secrets.PRIVATE_TOKEN_EULABS }}
          path: temp-app

      - name: Copiar arquivos do API
        run: |
          mkdir -p api
          rsync -av --delete --exclude='.git' temp-api/ api/

      - name: Copiar arquivos do APP
        run: |
          mkdir -p app
          rsync -av --delete --exclude='.git' temp-app/ app/

      - name: Criar Pull Request automático
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Atualização automática API e APP"
          branch: sync-updates
          title: "Atualização automática dos projetos API e APP"
          body: |
            Este PR foi gerado automaticamente pelo GitHub Actions.
            Inclui as últimas atualizações dos repositórios:
            - **API:** riverdata/eucatur-pricing-api
            - **APP:** riverdata/eucatur-pricing-app
          delete-branch: true
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
      
      - name: Auto-merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash


